<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Loading and spawning maps - SUMMIT</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Loading and spawning maps";
    var mkdocs_page_input_path = "tutorials/loading_and_spawning_maps.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> SUMMIT</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Getting started</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../getting_started/introduction/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../getting_started/setting_up/">Setting up SUMMIT</a>
                </li>
                <li class="">
                    
    <a class="" href="../../getting_started/building/">Building SUMMIT</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tutorials</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../preparing_maps/">Preparing maps</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Loading and spawning maps</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#connecting-to-the-simulator">Connecting to the simulator</a></li>
    

    <li class="toctree-l3"><a href="#roads-and-roadmarks">Roads and roadmarks</a></li>
    

    <li class="toctree-l3"><a href="#sidewalks">Sidewalks</a></li>
    

    <li class="toctree-l3"><a href="#landmarks">Landmarks</a></li>
    

    <li class="toctree-l3"><a href="#satellitegeneral-imagery">Satellite/general imagery</a></li>
    

    <li class="toctree-l3"><a href="#saving-and-loading-meshes">Saving and loading meshes</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../using_roads_and_sidewalks/">Using roads and sidewalks</a>
                </li>
                <li class="">
                    
    <a class="" href="../simulating_traffic/">Simulating traffic</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../references/python_api/">Python API reference</a>
                </li>
                <li class="">
                    
    <a class="" href="../../references/summit_map_library/">SUMMIT map library</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">SUMMIT</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorials &raquo;</li>
        
      
    
    <li>Loading and spawning maps</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="admonition important">
<p class="admonition-title">Important</p>
<p>SUMMIT comes with scripts that spawn all relevant map objects covered in this tutorial. You may use it directly them <code>&lt;summit_root&gt;/PythonAPI/examples/spawn_meshes.py</code> and <code>&lt;summit_root&gt;/PythonAPI/examples/spawn_imagery.py</code>, without going through this tutorial.</p>
<p>Note that these scripts require that you have already <a href="/tutorials/preparing_maps/#optional-downloading-satellite-imagery">cached the map object meshes</a> and <a href="/tutorials/preparing_maps/#optional-caching-map-object-meshes">downloaded the satellite imagery</a>. For built-in SUMMIT maps, these have already been done for you, so you may go ahead with using the scripts directly, skipping this tutorial.</p>
</div>
<h1 id="connecting-to-the-simulator">Connecting to the simulator</h1>
<p>The steps to connect to the simulator <a href="https://carla.readthedocs.io/en/latest/python_api_tutorial/#connecting-and-retrieving-the-world">derives from CARLA</a>. A client object is created from which the world is received:</p>
<pre><code class="python">client = carla.Client('localhost', 2000)
world = client.get_world()
</code></pre>

<h1 id="roads-and-roadmarks">Roads and roadmarks</h1>
<p>Roads are represented using SUMO networks, which are loaded into memory via a SUMO network file:</p>
<pre><code class="python">sumo_network = carla.SumoNetwork.load(PATH_TO_SUMO_NETWORK_FILE)
</code></pre>

<p>The occupancy map (i.e. mesh) for the road can be produced by calling:</p>
<pre><code class="python">sumo_network_occupancy = sumo_network.create_occupancy_map()
</code></pre>

<p>If you required roadmarks (e.g. lane dividers), SUMMIT provides a fully automated way to generate the roadmarks' mesh:</p>
<pre><code class="python">roadmark_occupancy = sumo_network.create_roadmark_occupancy_map()
</code></pre>

<p>The road and roadmarks' meshes are then sent to the simulator and spawned dynamically:</p>
<pre><code class="python"># Get mesh triangles, and defines material and segmentation tag for road.
# Roadmarks' mesh is subtracted from the road's mesh to prevent flickering due to overlaps.
road_triangles = sumo_network_occupancy.difference(roadmark_occupancy).get_mesh_triangles()
road_material = '/Game/Carla/Static/GenericMaterials/Masters/LowComplexity/M_Road1'
road_segmentation = 7 # Road (defined by CARLA).

# Get mesh triangles, and defines material and segmentation tag for roadmarks.
roadmark_triangles = roadmark_occupancy.get_mesh_triangles()
roadmark_material = '/Game/Carla/Static/GenericMaterials/LaneMarking/M_MarkingLane_W'
roadmark_segmentation = 6 # Road line (defined by CARLA).

# Spawn road and roadmarks dynamically in simulator.
world.spawn_dynamic_mesh(road_triangles, road_material, road_segmentation)
world.spawn_dynamic_mesh(roadmark_triangles, roadmark_material, roadmark_segmentation)
</code></pre>

<h1 id="sidewalks">Sidewalks</h1>
<p>Sidewalks are represented using a set of oriented polygons with holes using <code>carla.Sidewalk</code> objects. 
In SUMMIT, sidewalks are automatically calculated as boundaries along road meshes:</p>
<pre><code class="python"># Create sidewalk 1.5 meters from road's mesh.
sidewalk = sumo_network_occupancy.create_sidewalk(1.5)

# Create sidewalk's mesh for a sidewalk width of 3.0 meters.
sidewalk_occupancy = sidewalk.create_occupancy_map(3.0)

# Get mesh triangles, and defines sidewalk material and segmentation tag for sidewalk.
sidewalk_triangles = sidewalk_occupancy.get_mesh_triangles()
sidewalk_material = '/Game/Carla/Static/GenericMaterials/Ground/GroundWheatField_Mat'
sidewalk_segmentation = 8 # Sidewalk (defined by CARLA).

# Spawn sidewalk dynamically in simulator.
world.spawn_dynamic_mesh(sidewalk_triangles, sidewalk_material, sidewalk_segmentation)
</code></pre>

<h1 id="landmarks">Landmarks</h1>
<p>Landmarks can be loaded from the map's OSM file:</p>
<pre><code class="python">landmark_occupancies = carla.Landmark.load(PATH_TO_OSM_FILE, sumo_network.offset)
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>sumo_network.offset</code> argument applies an offset to each landmark equal to the offset applied to the SUMO network. This is required because the SUMO network itself is offset (by <code>sumo_network.offset</code>) such that its bounds are aligned to the origin in the simulator. On the other hand, the landmarks maintain their global geographic position. Without applying the correct offset, the landmarks may end up at positions far away from the SUMO network.</p>
</div>
<p>For each landmark, we can retrieve the ground, ceiling, and wall meshes to be spawned in the simulator:</p>
<pre><code class="python">landmark_material = '/Game/Carla/Static/Buildings/aa_wall_mat'
landmark_segmentation = 1 # Building (defined by CARLA)

for landmark_occupancy in landmark_occupancies:
    # Get ground mesh, applying a vertical offset of 0 meters.
    ground_mesh_triangles = landmark_occupancy.get_mesh_triangles(0.0)

    # Get ceiling mesh triangles, with a vertical offset of 20.0 meters.
    ceiling_mesh_triangles = landmark_occupancy.get_mesh_triangles(20.0)

    # Get vertically rising mesh triangles, with a height of 20.0 meters.
    wall_mesh_triangles = landmark_occupancy.get_wall_mesh_triangles(20.0)

    # Spawn meshes dynamically in simulator.
    world.spawn_dynamic_mesh(ground_mesh_triangles, landmark_material, landmark_segmentation)
    world.spawn_dynamic_mesh(ceiling_mesh_triangles, landmark_material, landmark_segmentation)
    world.spawn_dynamic_mesh(wall_mesh_triangles, landmark_material, landmark_segmentation)
</code></pre>

<p>The landmarks may sometime overlap with the roads and sidewalks. You may wish to do some preprocessing to remove these overlaps:</p>
<pre><code class="python">sumo_network_occupancy = ... # Get road mesh.
sidewalk_occupancy = ... # Get sidewalk mesh.
landmark_occupancies = ... # Get landmark meshes.

# Subtract road mesh and sidewalk mesh from landmark meshes.
landmark_occupancies = [
        l.difference(sumo_network_occupancy).difference(sidewalk_occupancy) 
        for l in landmark_occupancies]

# Filter empty landmark meshes.
landmark_occupancies = [l for l in landmark_occupancies if not l.is_empty]
</code></pre>

<h1 id="satellitegeneral-imagery">Satellite/general imagery</h1>
<p>To spawn satellite imagery in SUMMIT, we provide a utility script at <code>&lt;summit_root&gt;/PythonAPI/examples/spawn_imagery.py</code>. It assumes that you have already <a href="/tutorials/preparing_maps/#optional-downloading-satellite-imagery">downloadeded the satellite imagery</a>. To use, run</p>
<pre><code class="python">spawn_imagery.py --dataset &lt;map_name&gt;
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spawning satellite imagery involves a tedious amount of work (such as looking up the map tile indices from geographical coordinates), and we highly recommend using the provided script which already deals with these efforts.</p>
</div>
<p>The dynamic image tiles that SUMMIT expose to spawn satellite imagery can also be used to spawn any JPEG image in general. The below example spawns a an arbitrary image on a square region that is slanted along the z axis.</p>
<pre><code class="python">with open(JPEG_PATH, 'rb') as f:
    # NOTE: Python 2 reads the file as a string instead of as an
    # array of bytes. ord(b) checks for this and converts accordingly.
    data = [ord(b) if isinstance(b, str) else b for b in f.read()]

segmentation = 9 # Vegetation (defined by CARLA)
bounds_min = carla.Vector3D(0, 0, -10)
bounds_max = carla.Vector3D(100, 100, 10)

world.spawn_dynamic_tile_mesh(bounds_min, bounds_max, data, segmentation)
</code></pre>

<h1 id="saving-and-loading-meshes">Saving and loading meshes</h1>
<p>You may wish to save meshes onto the disk, and reload them for future use, speeding up loading times by elimiating the unnecessary recomputations:</p>
<pre><code class="python"># Saves mesh to the disk at SAVE_PATH.
sumo_network_occupancy.save(SAVE_PATH)

# Reload mesh from the disk.
sumo_network_occupancy = carla.OccupancyMap.load(SAVE_PATH)

# Spawn dynamically in simulator.
world.spawn_dynamic_mesh(sumo_network_occupancy.get_mesh_triangles(), road_material, road_segmentation)
</code></pre>

<p>This example works for any <code>carla.OccupancyMap</code> instance, not just for roads.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../using_roads_and_sidewalks/" class="btn btn-neutral float-right" title="Using roads and sidewalks">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../preparing_maps/" class="btn btn-neutral" title="Preparing maps"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../preparing_maps/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../using_roads_and_sidewalks/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
